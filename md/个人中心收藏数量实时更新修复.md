# 个人中心收藏数量实时更新修复

## 问题描述

用户从商品详情页面点击收藏后，返回个人中心页面时，收藏数量角标没有及时更新，需要手动刷新页面才能看到最新的收藏数量。

## 问题分析

1. **页面生命周期问题**：个人中心页面的 `onShow` 生命周期没有正确触发
2. **数据同步机制缺失**：详情页面的收藏操作和个人中心页面之间缺少数据同步机制
3. **页面焦点检测不准确**：无法准确判断用户何时返回个人中心页面

## 解决方案

### 1. 全局事件通信机制 ✅

使用 uni-app 的全局事件系统实现页面间的数据同步：

**发送事件**（详情页面）：
```typescript
// 商品详情页面 - 收藏操作成功后
uni.$emit('favoriteChanged', {
  type: 'product',
  id: productId.value,
  is_favorited: res.data.is_favorited
})

// 文章详情页面 - 收藏操作成功后  
uni.$emit('favoriteChanged', {
  type: 'article', 
  id: articleId.value,
  is_favorited: res.data.is_favorited
})
```

**监听事件**（个人中心页面）：
```typescript
// 监听收藏状态变化
const handleFavoriteChange = () => {
  console.log('收到收藏状态变化通知，刷新用户数据')
  fetchUserData()
}

// 注册全局事件监听
uni.$on('favoriteChanged', handleFavoriteChange)

// 页面卸载时清理
onUnmounted(() => {
  uni.$off('favoriteChanged', handleFavoriteChange)
})
```

### 2. 页面焦点检测机制 ✅

添加窗口焦点监听，当用户返回页面时自动刷新数据：

```typescript
let lastFetchTime = 0
const handlePageFocus = () => {
  const now = Date.now()
  // 防抖：如果距离上次获取数据超过2秒，则重新获取
  if (now - lastFetchTime > 2000) {
    console.log('页面获得焦点，刷新用户数据')
    fetchUserData()
    lastFetchTime = now
  }
}

// 监听窗口焦点事件
window.addEventListener('focus', handlePageFocus)
```

### 3. 清理机制 ✅

在页面卸载时正确清理事件监听器，防止内存泄漏：

```typescript
onUnmounted(() => {
  // 移除全局事件监听
  uni.$off('favoriteChanged', handleFavoriteChange)
  window.removeEventListener('focus', handlePageFocus)
})
```

## 实现效果

### 更新前 ❌
1. 用户在商品详情页面点击收藏
2. 收藏成功，显示提示信息  
3. 用户返回个人中心页面
4. **收藏数量角标没有变化**
5. 需要手动下拉刷新页面才能看到更新

### 更新后 ✅
1. 用户在商品详情页面点击收藏
2. 收藏成功，显示提示信息
3. **自动触发全局事件通知**
4. 用户返回个人中心页面
5. **页面焦点检测触发数据刷新**
6. **收藏数量角标立即更新为最新值**

## 技术特点

### 🚀 **实时同步**
- 收藏操作后立即通知相关页面
- 页面切换时自动检测并刷新数据

### 🔒 **防抖机制**  
- 2秒内多次焦点切换只触发一次刷新
- 避免频繁的API调用

### 🧹 **内存安全**
- 正确清理事件监听器
- 防止内存泄漏

### 📱 **用户体验**
- 无需手动刷新
- 数据始终保持最新状态
- 操作响应及时

## 测试场景

### 基础功能测试
1. **商品收藏更新**：
   - 在商品详情页面点击收藏
   - 返回个人中心查看角标是否立即更新

2. **文章收藏更新**：
   - 在文章详情页面点击收藏  
   - 返回个人中心查看角标是否立即更新

3. **取消收藏更新**：
   - 取消收藏后角标数量是否正确减少

### 边界情况测试
1. **网络异常**：
   - 收藏操作失败时不触发更新事件
   - 个人中心数据获取失败时的降级处理

2. **快速操作**：
   - 快速连续收藏/取消收藏
   - 防抖机制是否正常工作

3. **页面切换**：
   - 频繁切换页面时的性能表现
   - 事件监听是否正确清理

## 监控和调试

### 控制台日志
```
收到收藏状态变化通知，刷新用户数据
页面获得焦点，刷新用户数据
获取收藏统计数据
```

### 调试建议
1. 打开浏览器开发者工具的控制台
2. 执行收藏操作观察日志输出
3. 切换页面查看焦点检测是否触发
4. 检查网络面板确认API调用时机

## 注意事项

1. **全局事件命名**：
   - 使用 `favoriteChanged` 作为事件名
   - 保持事件名称的一致性

2. **事件数据格式**：
   ```typescript
   {
     type: 'product' | 'article',
     id: number,
     is_favorited: boolean
   }
   ```

3. **性能考虑**：
   - 防抖机制避免频繁API调用
   - 及时清理事件监听器

4. **兼容性**：
   - 使用uni-app标准的事件系统
   - 兼容小程序和H5环境

## 完成状态

✅ 全局事件通信机制已建立
✅ 页面焦点检测机制已实现  
✅ 商品详情页面收藏事件已集成
✅ 文章详情页面收藏事件已集成
✅ 个人中心页面事件监听已配置
✅ 内存清理机制已实现
✅ 防抖机制已添加

现在用户的收藏操作会立即同步到个人中心页面，无需手动刷新！